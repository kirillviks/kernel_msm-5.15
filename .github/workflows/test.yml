name: "Build kernels Test"

env:
  OUT_DIR: "out"
  KERNEL_VERSION: "5.15"
  ANDROID_VERSION: "13"

on:
  workflow_dispatch:
    inputs:
      kernelSourceURL:
        description: "Kernel source URL"
        required: true
        type: string
        default: "https://github.com/topnotchfreaks/kernel_msm-5.15"
      kernelBranch:
        description: "Kernel branch"
        required: false
        type: string
        default: "codelinaro"
      kernelDevice:
        description: "Device (used for defconfig)"
        required: true
        type: string
        default: "gki"
      localVersion:
        description: "Custom Localversion"
        required: false
        type: string
        default: "-TopNotchFreaks"
      buildKSU:
        description: "Kernel Variant"
        required: true
        type: choice
        default: "both"
        options:
          - "noksu"
          - "ksu"
          - "both"
      ksuVariant:
        description: "KSU implementation"
        required: true
        type: choice
        default: "sukisu-ultra"
        options:
          - "kernelsu"
          - "sukisu-ultra"
          - "rksu"
          - "wildksu"
      optimizationLevel:
        description: "Compiler optimization level"
        required: false
        type: choice
        default: "O2"
        options:
          - "O2"
          - "O3"
          - "Os"
      tickRate:
        description: "Kernel tick rate (Hz)"
        required: false
        type: choice
        default: "250"
        options:
          - "100"
          - "250"
          - "300"
          - "1000"

jobs:
  Build-Kernel:
    name: "üöÄ Build Kernel"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ${{ fromJSON(
          inputs.buildKSU == 'both' && '["noksu", "ksu"]' ||
          inputs.buildKSU == 'ksu' && '["ksu"]' ||
          '["noksu"]' ) }}
    env:
      kernelDir: common_${{ github.event.inputs.kernelDevice }}
      kernelName: common
      DEFCONFIG_NAME: ${{ github.event.inputs.kernelDevice }}_defconfig
      WORK_DIR: ${{ github.workspace }}

    steps:
      - name: "‚ú® Setup workspace"
        run: |
          mkdir -p $kernelDir
          echo "BUILD_TIME=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          sudo apt-get update -qq
          sudo apt-get install -y repo rsync aria2

      - name: "üåü Clone kernel source"
        working-directory: ./${{ env.kernelDir }}
        run: |
          git clone --recursive --branch ${{ github.event.inputs.kernelBranch }} \
            ${{ github.event.inputs.kernelSourceURL }} ${{ env.kernelName }} --depth=1

      - name: "üì• Initialize repo"
        working-directory: ${{ env.WORK_DIR}}
        run: |
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android13-5.15-lts --depth=1
          repo sync --optimized-fetch --prune --no-clone-bundle --no-tags -j$(nproc --all)
          
          rm -rf .repo
          rm -rf common

          aria2c -x 16 -s 16 -o prebuilts/clang/host/linux-x86/clang-r547379.tar.gz "https://github.com/topnotchfreaks/clang/releases/download/v1.0.0/clang-r547379.tar.gz"
          mkdir -p prebuilts/clang/host/linux-x86/clang-r547379
          tar -xzf prebuilts/clang/host/linux-x86/clang-r547379.tar.gz -C prebuilts/clang/host/linux-x86/clang-r547379
          rm -rf prebuilts/clang/host/linux-x86/clang-r547379.tar.gz

          rm -rf prebuilts/clang/host/linux-x86/clang-3289846
          rm -rf prebuilts/clang/host/linux-x86/clang-r450784e
          rm -rf prebuilts/clang/host/linux-x86/clang-stable
          
          sed -i \
           -e 's/^BRANCH=.*/BRANCH=android13-5.15/' \
           -e 's/^CLANG_VERSION=.*/CLANG_VERSION=r547379/' \
           ${{ env.kernelDir }}/${{ env.kernelName }}/build.config.constants
          
          sed -i '/^DEFCONFIG=gki_defconfig/d' ${{ env.kernelDir }}/${{ env.kernelName }}/build.config.gki
          sed -i '$a\DEFCONFIG=${{ env.DEFCONFIG_NAME }}' ${{ env.kernelDir }}/${{ env.kernelName }}/build.config.gki
          sed -i '/^POST_DEFCONFIG_CMDS="check_defconfig"/d' ${{ env.kernelDir }}/${{ env.kernelName }}/build.config.gki

          sed -i \
           -e '/^KMI_SYMBOL_LIST_STRICT_MODE=/d' \
           -e '/^TRIM_NONLISTED_KMI=/d' \
           -e '/^KMI_ENFORCED=/d' \
           -e '$a\KMI_SYMBOL_LIST_STRICT_MODE=0' \
           -e '$a\TRIM_NONLISTED_KMI=0' \
           -e '$a\KMI_ENFORCED=0' \
           -e '/^MODULES_ORDER=/d' \
           -e '/^MODULES_LIST=/d' \
           ${{ env.kernelDir }}/${{ env.kernelName }}/build.config.gki.aarch64

      - name: "‚öôÔ∏è Configure kernel optimization and tick rate"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_NAME }}"
          
          # Remove existing optimization configs
          sed -i '/CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE/d' "$CONFIG_FILE"
          sed -i '/CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3/d' "$CONFIG_FILE"
          sed -i '/CONFIG_CC_OPTIMIZE_FOR_SIZE/d' "$CONFIG_FILE"
          
          # Apply selected optimization level
          case "${{ github.event.inputs.optimizationLevel }}" in
            O2)
              echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> "$CONFIG_FILE"
              echo "# CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3 is not set" >> "$CONFIG_FILE"
              echo "# CONFIG_CC_OPTIMIZE_FOR_SIZE is not set" >> "$CONFIG_FILE"
              ;;
            O3)
              echo "# CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE is not set" >> "$CONFIG_FILE"
              echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=y" >> "$CONFIG_FILE"
              echo "# CONFIG_CC_OPTIMIZE_FOR_SIZE is not set" >> "$CONFIG_FILE"
              ;;
            Os)
              echo "# CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE is not set" >> "$CONFIG_FILE"
              echo "# CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3 is not set" >> "$CONFIG_FILE"
              echo "CONFIG_CC_OPTIMIZE_FOR_SIZE=y" >> "$CONFIG_FILE"
              ;;
          esac
          
          # Remove existing tick rate configs
          sed -i '/^CONFIG_NO_HZ=/d' "$CONFIG_FILE"
          sed -i '/^CONFIG_HZ=/d' "$CONFIG_FILE"
          sed -i '/^CONFIG_HZ_100=/d' "$CONFIG_FILE"
          sed -i '/^CONFIG_HZ_250=/d' "$CONFIG_FILE"
          sed -i '/^CONFIG_HZ_300=/d' "$CONFIG_FILE"
          sed -i '/^CONFIG_HZ_1000=/d' "$CONFIG_FILE"
          
          # Apply selected tick rate
          case "${{ github.event.inputs.tickRate }}" in
            100)
              echo "CONFIG_NO_HZ_IDLE=y" >> "$CONFIG_FILE"
              echo "CONFIG_HZ=100" >> "$CONFIG_FILE"
              echo "CONFIG_HZ_100=y" >> "$CONFIG_FILE"
              ;;
            250)
              echo "CONFIG_NO_HZ_IDLE=y" >> "$CONFIG_FILE"
              echo "CONFIG_HZ=250" >> "$CONFIG_FILE"
              echo "CONFIG_HZ_250=y" >> "$CONFIG_FILE"
              ;;
            300)
              echo "CONFIG_NO_HZ_IDLE=y" >> "$CONFIG_FILE"
              echo "CONFIG_HZ=300" >> "$CONFIG_FILE"
              echo "CONFIG_HZ_300=y" >> "$CONFIG_FILE"
              ;;
            1000)
              echo "CONFIG_NO_HZ_IDLE=y" >> "$CONFIG_FILE"
              echo "CONFIG_HZ=1000" >> "$CONFIG_FILE"
              echo "CONFIG_HZ_1000=y" >> "$CONFIG_FILE"
              ;;
          esac
          
          # Set localversion
          if [ -n "${{ github.event.inputs.localVersion }}" ]; then
            echo "CONFIG_LOCALVERSION=\"${{ github.event.inputs.localVersion }}\"" >> "$CONFIG_FILE"
            echo "CONFIG_LOCALVERSION_AUTO=n\"" >> "$CONFIG_FILE"
          fi
          
          # Basic optimizations
          echo "CONFIG_KALLSYMS=y" >> "$CONFIG_FILE"
          
          echo "‚úÖ Applied -${{ github.event.inputs.optimizationLevel }} optimization"
          echo "‚úÖ Applied ${{ github.event.inputs.tickRate }}Hz tick rate"

      - name: "üîß Add BBG Support (KSU variant only)"
        if: matrix.variant == 'ksu'
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          echo "Adding BBG..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> arch/arm64/configs/${{ env.DEFCONFIG_NAME }}
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/landlock/landlock,baseband_guard/ } }' security/Kconfig

      - name: "üîß Setup KernelSU - Official with SUSFS"
        if: matrix.variant == 'ksu' && github.event.inputs.ksuVariant == 'kernelsu'
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          rm -rf ./KernelSU ./drivers/kernelsu

          echo "üì¶ Installing official KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main

          echo "üì¶ Cloning SUSFS4KSU..."
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android13-5.15

          SUSFS_KERNEL_PATCH="susfs4ksu/kernel_patches/50_add_susfs_in_gki-android13-5.15.patch"

          echo "üîß Applying SUSFS kernel patch if possible..."
          if patch -p1 < "$SUSFS_KERNEL_PATCH"; then
            echo "‚úÖ SUSFS patch successfully applied"
          else
            echo "‚ö†Ô∏è SUSFS patch failed ‚Äî copying files manually"
          fi

          echo "üìÑ Forcing SUSFS source injection..."

          # Always replace fs/susfs.c
          mkdir -p fs
          cp -f susfs4ksu/kernel_patches/fs/susfs.c fs/susfs.c
          echo "‚úî Copied fs/susfs.c"

          # Always replace include/linux/susfs.h
          mkdir -p include/linux
          cp -f susfs4ksu/kernel_patches/include/linux/susfs.h include/linux/susfs.h
          echo "‚úî Copied include/linux/susfs.h"

          # NEW: Also install missing susfs_def.h
          if [ -f susfs4ksu/kernel_patches/include/linux/susfs_def.h ]; then
            cp -f susfs4ksu/kernel_patches/include/linux/susfs_def.h include/linux/susfs_def.h
            echo "‚úî Copied include/linux/susfs_def.h"
          else
            echo "‚ö†Ô∏è susfs_def.h not found in repo"
          fi

          echo "üì¶ Injecting SUSFS -> KernelSU integration files"
          if [ -d "susfs4ksu/kernel_patches/KernelSU/kernel" ]; then
            cp -rf susfs4ksu/kernel_patches/KernelSU/kernel/* KernelSU/kernel/
            echo "‚úî Copied SUSFS KernelSU integration files"
          fi

          echo "üîß Applying SUSFS -> KernelSU patch..."
          KSU_PATCH="susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"

          if [ -f "$KSU_PATCH" ]; then
            cd KernelSU
            if patch -p1 --dry-run < ../$KSU_PATCH >/dev/null; then
              patch -p1 < ../$KSU_PATCH && echo "‚úî Applied KSU SUSFS patch"
              cd ..
            else
              echo "‚ö†Ô∏è KSU SUSFS patch failed ‚Äî applying manual fallback"
              cd ..
              sed -i '/#include <linux\/pid.h>/a #include <linux/susfs.h>' KernelSU/kernel/ksu.c
              sed -i '/ksu_core_init()/a \\tsusfs_init();' KernelSU/kernel/ksu.c
            fi
          else
            echo "‚ö†Ô∏è KSU patch missing ‚Äî manually injecting changes"
            sed -i '/#include <linux\/pid.h>/a #include <linux/susfs.h>' KernelSU/kernel/ksu.c
            sed -i '/ksu_core_init()/a \\tsusfs_init();' KernelSU/kernel/ksu.c
          fi

          echo "üîç Verifying SUSFS files..."
          for f in fs/susfs.c include/linux/susfs.h include/linux/susfs_def.h; do
            if [ -f "$f" ]; then echo "‚úî Found: $f"; else echo "‚ùå Missing: $f"; fi
          done

          rm -rf susfs4ksu

          CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_NAME }}"
          cat >> "$CONFIG_FILE" << 'EOF'
          CONFIG_KSU=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_OVERLAY_FS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

          echo "üéâ Official KernelSU + SUSFS fully integrated!"

      - name: "üîß Setup SukiSU-Ultra (Stable)"
        if: matrix.variant == 'ksu' && github.event.inputs.ksuVariant == 'sukisu-ultra'
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          rm -rf ./KernelSU ./drivers/kernelsu
          
          # Install SukiSU-Ultra with SUSFS
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          
          # Apply SUSFS patch
          PATCH_URL="https://api.github.com/repos/topnotchfreaks/kernel_patches/releases/latest"
          SUSFS_PATCH=$(curl -s "$PATCH_URL" | grep "browser_download_url.*0001-Implement-SUSFS.*Android-13.*Kernel-5.15.*patch" | cut -d '"' -f 4 | head -n 1)
          
          if [ -n "$SUSFS_PATCH" ]; then
            curl -L -o susfs.patch "$SUSFS_PATCH"
            patch -p1 < susfs.patch || echo "Warning: SUSFS patch failed"
          fi
          
          # Add KSU configs
          CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_NAME }}"
          cat >> "$CONFIG_FILE" << 'EOF'
          CONFIG_KSU=y
          # CONFIG_KSU_MANUAL_HOOK is not set
          CONFIG_KPM=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF
          
          echo "‚úÖ Installed SukiSU-Ultra with SUSFS"

      - name: "üîß Setup rKSU"
        if: matrix.variant == 'ksu' && github.event.inputs.ksuVariant == 'rksu'
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          rm -rf ./KernelSU ./drivers/kernelsu
          
          # Install rKSU with SUSFS
          curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s susfs-rksu-master

          # Apply SUSFS patch
          PATCH_URL="https://api.github.com/repos/topnotchfreaks/kernel_patches/releases/latest"
          SUSFS_PATCH=$(curl -s "$PATCH_URL" | grep "browser_download_url.*0001-Implement-SUSFS.*Android-13.*Kernel-5.15.*patch" | cut -d '"' -f 4 | head -n 1)
          
          if [ -n "$SUSFS_PATCH" ]; then
            curl -L -o susfs.patch "$SUSFS_PATCH"
            patch -p1 < susfs.patch || echo "Warning: SUSFS patch failed"
          fi
          
          # Add KSU configs
          CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_NAME }}"
          cat >> "$CONFIG_FILE" << 'EOF'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF
          
          echo "‚úÖ Installed rKSU with SUSFS"

      - name: "üîß Setup Wild KSU with SUSFS"
        if: matrix.variant == 'ksu' && github.event.inputs.ksuVariant == 'wildksu'
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        run: |
          rm -rf ./KernelSU ./drivers/kernelsu
          
          echo "üì¶ Installing Wild KSU..."

          # Install WildKSU with SUSFS
          curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s susfs
          
          echo "‚úî Wild KSU installed successfully"
          
          # Clone SUSFS4KSU for kernel patches only (not KSU integration)
          echo "üì¶ Cloning SUSFS4KSU for kernel patches..."
          git clone --depth=1 https://github.com/belowzeroiq/susfs4ksu.git -b wild
          
          SUSFS_KERNEL_PATCH="susfs4ksu/kernel_patches/50_add_susfs_in_gki-android13-5.15.patch"
          
          echo "üîß Applying SUSFS kernel patch..."
          if patch -p1 < "$SUSFS_KERNEL_PATCH"; then
            echo "‚úÖ SUSFS patch successfully applied"
          else
            echo "‚ö†Ô∏è SUSFS patch failed ‚Äî copying files manually"
          fi

          echo "üîß Applying SUSFS -> KernelSU patch..."
          KSU_PATCH="susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
          
          echo "üìÑ Forcing SUSFS source injection..."
          
          # Always replace fs/susfs.c
          mkdir -p fs
          cp -f susfs4ksu/kernel_patches/fs/susfs.c fs/susfs.c
          echo "‚úî Copied fs/susfs.c"
          
          # Always replace include/linux/susfs.h
          mkdir -p include/linux
          cp -f susfs4ksu/kernel_patches/include/linux/susfs.h include/linux/susfs.h
          echo "‚úî Copied include/linux/susfs.h"
          
          # Also install missing susfs_def.h
          if [ -f susfs4ksu/kernel_patches/include/linux/susfs_def.h ]; then
            cp -f susfs4ksu/kernel_patches/include/linux/susfs_def.h include/linux/susfs_def.h
            echo "‚úî Copied include/linux/susfs_def.h"
          else
            echo "‚ö†Ô∏è susfs_def.h not found in repo"
          fi
          
          echo "üîç Verifying SUSFS files..."
          for f in fs/susfs.c include/linux/susfs.h include/linux/susfs_def.h; do
            if [ -f "$f" ]; then echo "‚úî Found: $f"; else echo "‚ùå Missing: $f"; fi
          done
          
          # Clean up SUSFS repo (we only needed kernel patches, not KSU integration)
          rm -rf susfs4ksu
          
          # Create symbolic link for drivers/kernelsu (if needed by build system)
          if [ ! -L "drivers/kernelsu" ]; then
            ln -sf ../KernelSU drivers/kernelsu
            echo "‚úî Created drivers/kernelsu symlink"
          fi
          
          # Add Wild KSU configs with SUSFS
          CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_NAME }}"
          cat >> "$CONFIG_FILE" << 'EOF'
          CONFIG_KSU=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_OVERLAY_FS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF
          
          echo "üéâ Wild KSU with SUSFS kernel patches fully integrated!"
  
      - name: "üî® Build kernel"
        working-directory: ${{ env.WORK_DIR }}
        run: |
          LTO=thin \
          BUILD_CONFIG=${{ env.kernelDir }}/${{ env.kernelName }}/build.config.gki.aarch64 \
          build/build.sh -j$(nproc --all)

      - name: "ü©π Apply KPM patch (SukiSU-Ultra only)"
        if: matrix.variant == 'ksu' && github.event.inputs.ksuVariant == 'sukisu-ultra'
        working-directory: ${{ env.WORK_DIR }}/out/dist
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch
          chmod +x patch
          ./patch
          mv oImage Image

      - name: "üì¶ Prepare artifact"
        working-directory: ${{ env.WORK_DIR }}
        run: |
          VARIANT_NAME="${{ matrix.variant }}"
          if [ "${{ matrix.variant }}" == "ksu" ]; then
            VARIANT_NAME="${{ matrix.variant }}"
          fi
          cp out/dist/Image Image.$VARIANT_NAME
          echo "ARTIFACT_NAME=kernel-${VARIANT_NAME}-${{ github.event.inputs.optimizationLevel }}-${{ github.event.inputs.tickRate }}hz" >> $GITHUB_ENV
          echo "IMAGE_NAME=Image.$VARIANT_NAME" >> $GITHUB_ENV

      - name: "üì§ Upload kernel"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.WORK_DIR }}/${{ env.IMAGE_NAME }}
          retention-days: 3

  Package-Kernels:
    name: "üì¶ Package kernels"
    runs-on: ubuntu-latest
    needs: Build-Kernel
    steps:
      - name: "üì• Download artifacts"
        uses: actions/download-artifact@v4
        with:
          path: ./kernels/

      - name: "üì¶ Create flashable ZIP"
        run: |
          BUILD_TIME=$(date +'%Y-%m-%d')
          git clone --depth=1 https://github.com/topnotchfreaks/AnyKernel3 -b master AnyKernel3
          
          # Copy kernels
          find kernels -name "Image.*" -exec cp {} AnyKernel3/ \;
          
          # Create ZIP with optimization and KSU variant info
          KSU_INFO=""
          if [ "${{ github.event.inputs.buildKSU }}" != "noksu" ]; then
            KSU_INFO="_${{ github.event.inputs.ksuVariant }}"
          fi
          ZIP_NAME="Anykernel3_${{ github.event.inputs.kernelBranch }}${KSU_INFO}_${{ github.event.inputs.optimizationLevel }}_${{ github.event.inputs.tickRate }}hz_${BUILD_TIME}.zip"
          cd AnyKernel3
          zip -r9 "../$ZIP_NAME" * -x .git/*
          cd ..
          echo "ZIP_PATH=$(pwd)/$ZIP_NAME" >> $GITHUB_ENV
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: "üì§ Upload final package"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_PATH }}
          retention-days: 7

      - name: "üì± Send to Telegram"
        if: always()
        run: |
          if [[ -f "${{ env.ZIP_PATH }}" ]]; then
            KSU_TEXT=""
            if [ "${{ github.event.inputs.buildKSU }}" != "noksu" ]; then
              KSU_TEXT="
          KSU Variant: ${{ github.event.inputs.ksuVariant }}"
            fi
            
            CAPTION="‚úÖ Kernel Build Complete
          Branch: ${{ github.event.inputs.kernelBranch }}
          Optimization: -${{ github.event.inputs.optimizationLevel }}
          Tick Rate: ${{ github.event.inputs.tickRate }}Hz
          Variants: ${{ github.event.inputs.buildKSU }}${KSU_TEXT}
          Time: $(date '+%Y-%m-%d %H:%M:%S')"
            
            curl -s -F document=@"${{ env.ZIP_PATH }}" \
                 -F caption="$CAPTION" \
                 -F chat_id=${{ secrets.TELEGRAM_USER_ID }} \
                 "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument"
          else
            curl -s -X POST \
                 -d chat_id=${{ secrets.TELEGRAM_USER_ID }} \
                 -d text="‚ùå Kernel build failed - Optimization: -${{ github.event.inputs.optimizationLevel }}, Tick: ${{ github.event.inputs.tickRate }}Hz" \
                 "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
          fi
